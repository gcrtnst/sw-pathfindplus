# PathfindPlus
PathfindPlus is an alternative implementation of ocean pathfinding that runs on the Stormworks addon.

## Overview
The Stormworks addon Lua already has a builtin function called `server.pathfindOcean` as a way to perform ocean pathfinding. Unfortunately, this function is prone to failure and is not very useful (see [the bug report](https://geometa.co.uk/support/stormworks/117/) for details). So I created PathfindPlus as an alternative implementation.

Advantages of PathfindPlus:
 - Pathfinding will always be successful, no matter what your starting point and destination are.

Disadvantages of PathfindPlus:
 - It takes about 5 seconds to initialize the addon and up to 1 second for each pathfinding.
 - You need to add about 16000 characters of code to the script. This corresponds to about 12% of the maximum number of characters in the script (131072).

## How to test PathfindPlus
You can test PathfindPlus with addons available on [GitHub](https://github.com/gcrtnst/sw-pathfindplus/tree/main/pathfindplus) or Steam Workshop (to be released later).

### Installing Addons
Addons can be installed as usual.
 1. Subscribe to the work in Steam Workshop. Alternatively, you can copy the [pathfindplus/](https://github.com/gcrtnst/sw-pathfindplus/tree/main/pathfindplus) directory itself under `%APPDATA%\Stormworks\data\missions`.
 1. From the Stormworks title screen, go to New Game > Enabled Addons to display the addons list.
 1. Check "PathfindPlus" in the "Saved" tab or "Workshop" tab.
 1. Then, create a new game as usual, and the addon will be enabled.

It is not possible to add addons to existing savedata (unless you edit the savedata directly).

### How to use custom commands
You can use the following custom commands in games with this addon.

```
?pathfind [-start START_X START_Y] [-end END_X END_Y]
```

 - `?pathfind` will perform pathfinding and output the results.
 - The `-start` flag can be used to specify the starting point. If not specified, the current position of the player will be used.
 - The `-end` flag can be used to specify a destination. If not specified, a random location will be used.

### Viewing the results of pathfinding
The results of the pathfinding will be displayed on the map.
 - The starting point and destination will be displayed as map markers.
 - The results of pathfinding by PathfindPlus are displayed as solid lines.
 - The results of pathfinding by the builtin function `server.pathfindOcean` are shown as dashed lines for comparison.

Also, the following message will be output to the chat.
 - The first line shows the calculation time of `server.pathfindOcean` and the total distance of paths generated by the function.
 - The second line shows the calculation time of PathfindPlus and the total distance of the paths generated by PathfindPlus.
 - If PathfindPlus determines that you cannot get to your destination unless you pass through a non-ocean tile, it will display [unreachable] in the second line.
```
PathfindOcean: 0ms, 88.1km
PathfindPlus: 38ms, 85.4km [unreachable]
```

### Examples of custom commands
 - `?pathfind`: When run with no arguments, the player's current location is used as the starting point and a random location as the destination.
 - `?pathfind -start -64000 -64000 -end 64000 64000`: Uses `-start` and `-end` to set the starting point to (-64000, -64000) and the destination to (64000, 64000).

## How to embed PathfindPlus in an addon
You can embed and use PathfindPlus in any addon by following the steps below.
 1. Copy the entire `buildPathfinder` function in [script.lua](https://github.com/gcrtnst/sw-pathfindplus/blob/main/pathfindplus/script.lua) to the addon you want to embed.
 1. During addon initialization, call the `buildPathfinder` function and keep the returned Pathfinder object in a global variable.
 1. Use the `pathfindOcean` method to find a route. The arguments and return values of the `pathfindOcean` method are the same as those of `server.pathfindOcean`.

Sample Script:
```lua
function onCreate(is_world_create)
    -- initialization
    pf = buildPathfinder()
end

function onCustomCommand(full_message, user_peer_id, is_admin, is_auth, cmd, ...)
    -- call pf:pathfindOcean wherever you want
    local path_list = pf:pathfindOcean(matrix_start, matrix_end)
end

function buildPathfinder()
    -- snip
end

```

### Performance Tips
PathfindPlus does not perform as well as `server.pathfindOcean`. Please keep the following in mind to get better performance.
 - Avoid calling the `pathfindOcean` method every tick. Keep the result of pathfinding in a variable and reuse it as much as possible.
 - Avoid calling the `buildPathfinder` function every time you want to find a path, and call it only once when initializing the addon.
 - If you set a starting point or a destination that cannot be reached without passing through a non-ocean tile, the route search will take a long time. You can use the `getOceanReachable` method to check in advance if your path includes non-ocean tiles (the `getOceanReachable` method takes a constant time regardless of the starting point and destination).
 - The shorter the distance, the faster the pathfinding will be completed.

### Reference
#### `pf = buildPathfinder()`
`buildPathfinder` creates a Pathfinder object, initializes it and returns it.
It takes about 5 seconds to initialize.
Pathfinder objects cannot be saved in `g_savedata` because they contain functions and non-ASCII strings.

#### `{ [i] = {x = world_x, z = world_z} } = pf:pathfindOcean(matrix_start, matrix_end)`
`pathfindOcean` performs ocean pathfinding.
 - The `matrix_start` specifies the matrix of the starting point.
 - The `matrix_end` specifies the matrix of the destination.
 - The return value is a list of the resulting path, starting at index 1. The list contains the next point of the starting point to the point of the destination in order.

#### `is_reachable = pf:getOceanReachable(matrix_start, matrix_end)`
`getOceanReachable` checks if it is possible to reach the destination from the starting point only through ocean tiles.
 - The `matrix_start` specifies the matrix of the starting point.
 - The `matrix_end` specifies the matrix of the destination.
 - The return value is of type boolean. When `true`, the path returned by the `pathfindOcean` method is guaranteed to pass only through ocean tiles. If `false`, it will pass through non-ocean tiles, which may prevent you from reaching your destination due to land blockage or collision with the terrain.

# License
PathfindPlus is distributed under the terms of [The Unlicense](https://github.com/gcrtnst/sw-pathfindplus/blob/main/LICENSE).

# Links
 - GitHub Repository: [https://github.com/gcrtnst/sw-pathfindplus](https://github.com/gcrtnst/sw-pathfindplus)
 - Bug Report: [https://geometa.co.uk/support/stormworks/117/](https://geometa.co.uk/support/stormworks/117/)
